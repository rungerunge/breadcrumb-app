{% comment %}
    Smart Breadcrumbs - Product Template
    Displays breadcrumb navigation for product pages with collection hierarchy
    v5.1.0
{% endcomment %}

<style>
  .breadcrumb-container {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    font-size: 14px;
    line-height: 1.4;
    margin: 10px 0;
    padding: 8px 12px;
    background-color: rgba(240, 240, 240, 0.5);
    border-radius: 4px;
  }
  .breadcrumb-list {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    padding: 0;
    margin: 0;
    list-style: none;
  }
  .breadcrumb-item {
    display: inline-flex;
    align-items: center;
  }
  .breadcrumb-link {
    color: #555;
    text-decoration: none;
    transition: color 0.2s ease;
  }
  .breadcrumb-link:hover {
    color: #000;
    text-decoration: underline;
  }
  .breadcrumb-separator {
    margin: 0 8px;
    color: #999;
  }
  .breadcrumb-current {
    font-weight: 500;
    color: #333;
  }
  @media (max-width: 480px) {
    .breadcrumb-container {
      font-size: 12px;
      padding: 6px 10px;
    }
    .breadcrumb-separator {
      margin: 0 6px;
    }
  }
</style>

{% liquid
  # Set up schema data
  assign schema_items = ''
  assign position = 1
  
  # Check for collection hierarchy - first try current collection
  assign current_collection = collection
  
  # If no collection context, find primary collection for the product
  unless current_collection
    assign current_collection = product.collections.first
  endunless
  
  # Check if product has parent collection through metafields
  assign parent_collection_handle = product.metafields.breadcrumbs.parent_collection 
  if parent_collection_handle == blank 
    assign parent_collection_handle = current_collection.metafields.breadcrumbs.parent_collection
  endif
  
  if parent_collection_handle != blank
    assign parent_collection = collections[parent_collection_handle]
  endif
  
  # Check for grandparent collection
  assign grandparent_collection_handle = parent_collection.metafields.breadcrumbs.parent_collection
  if grandparent_collection_handle != blank
    assign grandparent_collection = collections[grandparent_collection_handle]
  endif
%}

<nav class="breadcrumb-container" aria-label="breadcrumbs">
  <ol class="breadcrumb-list" itemscope itemtype="https://schema.org/BreadcrumbList">
    <!-- Home -->
    <li class="breadcrumb-item" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
      <a class="breadcrumb-link" href="/" itemprop="item">
        <span itemprop="name">Home</span>
      </a>
      <meta itemprop="position" content="{{ position }}" />
      {% assign position = position | plus: 1 %}
      <span class="breadcrumb-separator" aria-hidden="true">/</span>
    </li>
    
    <!-- Grandparent Collection (if available) -->
    {% if grandparent_collection %}
      <li class="breadcrumb-item" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a class="breadcrumb-link" href="{{ grandparent_collection.url }}" itemprop="item">
          <span itemprop="name">{{ grandparent_collection.title }}</span>
        </a>
        <meta itemprop="position" content="{{ position }}" />
        {% assign position = position | plus: 1 %}
        <span class="breadcrumb-separator" aria-hidden="true">/</span>
      </li>
    {% endif %}
    
    <!-- Parent Collection (if available) -->
    {% if parent_collection %}
      <li class="breadcrumb-item" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a class="breadcrumb-link" href="{{ parent_collection.url }}" itemprop="item">
          <span itemprop="name">{{ parent_collection.title }}</span>
        </a>
        <meta itemprop="position" content="{{ position }}" />
        {% assign position = position | plus: 1 %}
        <span class="breadcrumb-separator" aria-hidden="true">/</span>
      </li>
    {% endif %}
    
    <!-- Current Collection -->
    {% if current_collection %}
      <li class="breadcrumb-item" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a class="breadcrumb-link" href="{{ current_collection.url }}" itemprop="item">
          <span itemprop="name">{{ current_collection.title }}</span>
        </a>
        <meta itemprop="position" content="{{ position }}" />
        {% assign position = position | plus: 1 %}
        <span class="breadcrumb-separator" aria-hidden="true">/</span>
      </li>
    {% endif %}
    
    <!-- Current Product -->
    <li class="breadcrumb-item" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
      <span class="breadcrumb-current" itemprop="name">{{ product.title }}</span>
      <meta itemprop="item" content="{{ shop.url }}{{ product.url }}" />
      <meta itemprop="position" content="{{ position }}" />
    </li>
  </ol>
</nav>

<!-- Structured data for SEO -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": "{{ shop.url }}"
    }
    {% if grandparent_collection %}
    ,{
      "@type": "ListItem",
      "position": 2,
      "name": {{ grandparent_collection.title | json }},
      "item": "{{ shop.url }}{{ grandparent_collection.url }}"
    }
    {% endif %}
    {% if parent_collection %}
    ,{
      "@type": "ListItem",
      "position": {% if grandparent_collection %}3{% else %}2{% endif %},
      "name": {{ parent_collection.title | json }},
      "item": "{{ shop.url }}{{ parent_collection.url }}"
    }
    {% endif %}
    {% if current_collection %}
    ,{
      "@type": "ListItem",
      "position": {% if parent_collection %}{% if grandparent_collection %}4{% else %}3{% endif %}{% else %}{% if grandparent_collection %}3{% else %}2{% endif %}{% endif %},
      "name": {{ current_collection.title | json }},
      "item": "{{ shop.url }}{{ current_collection.url }}"
    }
    {% endif %}
    ,{
      "@type": "ListItem",
      "position": {{ position }},
      "name": {{ product.title | json }},
      "item": "{{ shop.url }}{{ product.url }}"
    }
  ]
}
</script>

{% comment %} Advanced debug information - only visible when ?debug=true is in URL {% endcomment %}
{% if request.design_mode or request.query_string contains 'debug=true' %}
  <div style="font-size: 12px; color: #777; background: #f7f7f7; padding: 10px; margin-top: 10px; border-radius: 4px;">
    <p style="margin: 0 0 5px 0;"><strong>Product Breadcrumb Debug Info:</strong></p>
    <p style="margin: 0 0 5px 0;">Product: {{ product.title }} ({{ product.handle }})</p>
    <p style="margin: 0 0 5px 0;">Collection Hierarchy:</p>
    <ul style="margin: 0; padding-left: 20px;">
      <li>Current Collection: {% if current_collection %}{{ current_collection.title }} ({{ current_collection.handle }}){% else %}None{% endif %}</li>
      <li>Parent Collection: {% if parent_collection %}{{ parent_collection.title }} ({{ parent_collection.handle }}){% else %}None{% endif %}</li>
      <li>Grandparent Collection: {% if grandparent_collection %}{{ grandparent_collection.title }} ({{ grandparent_collection.handle }}){% else %}None{% endif %}</li>
    </ul>
    <p style="margin: 5px 0 0 0;">All Product Collections:</p>
    <ul style="margin: 0; padding-left: 20px;">
      {% for collection in product.collections %}
        <li>{{ collection.title }} ({{ collection.handle }})</li>
      {% else %}
        <li>No collections</li>
      {% endfor %}
    </ul>
  </div>
{% endif %}