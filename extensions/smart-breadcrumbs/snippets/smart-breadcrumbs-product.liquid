{% comment %}
    Smart Breadcrumbs - Product Page v5.2
    Enhanced collection detection with multi-method fallbacks
{% endcomment %}

{%- style -%}
.smart-breadcrumbs {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    padding: 10px 0;
    margin: 0;
    font-size: var(--breadcrumb-font-size, 14px);
    background-color: rgba(0, 0, 0, 0.03);
    padding: 8px 15px;
    border-radius: 4px;
}

.smart-breadcrumbs__link {
    color: var(--breadcrumb-color, #666);
    text-decoration: none;
    transition: color 0.2s ease;
}

.smart-breadcrumbs__link:hover {
    color: var(--breadcrumb-hover-color, #000);
}

.smart-breadcrumbs__separator {
    margin: 0 8px;
    color: var(--breadcrumb-separator-color, #999);
}

.smart-breadcrumbs__current {
    color: var(--breadcrumb-current-color, #333);
    font-weight: 500;
}

@media screen and (max-width: 768px) {
    .smart-breadcrumbs {
        font-size: var(--breadcrumb-mobile-font-size, 12px);
        padding: 8px 12px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
    }
    
    .smart-breadcrumbs::-webkit-scrollbar {
        display: none;
    }
    
    .smart-breadcrumbs__separator {
        margin: 0 4px;
    }
}
{%- endstyle -%}

{%- liquid
  # ENHANCED COLLECTION DETECTION LOGIC
  
  # Method 1: Use collection from URL context
  assign current_collection = collection
  
  # Method 2: Look for collection in URL
  if current_collection == blank and request.path contains '/collections/'
    assign path_parts = request.path | split: '/'
    assign collection_index = -1
    
    # Find collection index in URL path
    for part in path_parts
      if part == 'collections' and collection_index == -1
        assign collection_index = forloop.index
      endif
    endfor
    
    # If collection index was found and there's a handle after it
    if collection_index > -1 and path_parts.size > collection_index
      assign collection_handle = path_parts[collection_index]
      
      # Try to get collection from handle
      for coll in product.collections
        if coll.handle == collection_handle
          assign current_collection = coll
          break
        endif
      endfor
    endif
  endif
  
  # Method 3: Find primary collection (first collection)
  if current_collection == blank and product.collections.first
    assign current_collection = product.collections.first
  endif
  
  # Method 4: Look for 'primary' or 'main' tagged collection
  if current_collection == blank
    for coll in product.collections
      if coll.tags contains 'primary' or coll.tags contains 'main'
        assign current_collection = coll
        break
      endif
    endfor
  endif
-%}

<nav class="smart-breadcrumbs" aria-label="breadcrumb">
    <!-- Home Link -->
    <a href="/" class="smart-breadcrumbs__link">Home</a>
    
    {% if product %}
      <!-- Collection Link (if available through any method) -->
      {% if current_collection %}
        <span class="smart-breadcrumbs__separator">/</span>
        <a href="{{ current_collection.url }}" class="smart-breadcrumbs__link">{{ current_collection.title }}</a>
      {% elsif collection_handle %}
        <span class="smart-breadcrumbs__separator">/</span>
        <a href="/collections/{{ collection_handle }}" class="smart-breadcrumbs__link">{{ collection_handle | replace: '-', ' ' | capitalize }}</a>
      {% endif %}
      
      <!-- Current Product -->
      <span class="smart-breadcrumbs__separator">/</span>
      <span class="smart-breadcrumbs__current">{{ product.title }}</span>
    {% endif %}
</nav>

{%- unless product or debug != blank -%}
<!-- Add hidden debug info -->
<div style="display: none;" data-breadcrumb-debug>
  <div>Product object not available on this page</div>
  <div>Template: {{ template }}</div>
  <div>URL: {{ request.path }}</div>
</div>
{%- endunless -%}